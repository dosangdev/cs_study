# 12-1 동기화란

## 동기화의 의미

    동시다발적으로 실행되는 많은 프로세스는 서로 데이터를 주고받으며 협력하며 실행되기 위해 동기화를 해준다

- 프로세스 동기화: 프로세스들 사이의 수행 시기를 맞추는 것
  - 실행 순서 제어를 위한 동기화
    - ex) writer프로세스로 book.txt를 채우고 reader프로세스로 book.txt를 읽는 순서
  - 상호 배제를 위한 동기화: 공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘
    - ex) 계좌 잔액 문제, 생산자 소비자 문제

## 공유자원과 임계구역

- 공유 자원: 공동으로 이용하는 변수, 파일, 장치 등의 자원
- 임계 구역: 공유 자원에 접근하는 코드 중 동시에 실행하면 문제가 발생하는 코드 영역
  - 잘못된 실행으로 동시다발적으로 임계구역의 코드를 실행하여 문제가 발생하는 경우를 **레이스 컨디션**이라 한다.
  - 이런 **레이스 컨디션**을 방지하기 위해 **상호 배제를 위한 동기화**가 두 개 이상의 프로세스가 임계구역에 동시에 접근하지 못하도록 관리한다.
  - 운영체제는 이러한 임계 구역 문제를 아래 세 가지 원칙 하에 해결한다.
    - 상호배제: 한 프로세스가 임계구역에 진입했다면 다른 프로세스는 임계구역에 들어올 수 없다
    - 진행: 임계구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.
    - 유한 대기: 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계구역에 들어올 수 있어야 한다.(무한정 대기X)

# 12-2 동기화 기법

    동기화를 위한 대표적인 도구 - 뮤텍스 락, 세마포, 모니터

## 뮤텍스 락

- 임계 구역에 진입하는 프로세스가 '내가 지금 임계 구역에 있음'을 알리기 위해 만든 자물쇠 기능을 구현한 것이 뮤텍스 락
- 동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 다시 말해 상호 배제를 위한 동기화 도구
- 하나의 전역 변수와 두 개의 함수로 구현

  - 자물쇠 역할: 프로세스들이 공유하는 전역 변수 lock

  - 임계 구역을 잠그는 역할: acquire 함수

    - 프로세스가 임계 구역에 진입하기 전에 호출하는 함수
    - 기능
      - 임계 구역이 잠겨있다면 lock이 false가 될때까지 반복적으로 확인(while문으로 (끊임없이)확인 -> **바쁜 대기**라고 한다)
      - 임계 구역이 열려있다면 lock을 true로 바꿈

  - 임계 구역의 잠금을 해제하는 역할: release 함수
    - 임계구역에서의 작업이 끝나고 호출하는 함수
    - 기능: lock을 false로 바꿈

## 세마포

- 뮤텍스 락과 비슷하지만 공유 자원이 여러 개 있는 상황에서도 적용 가능한 동기화 도구(뮤텍스락보다 더 일반화된 방식)
- 종류
  - 이진 세마포
  - 카운팅 세마포
- 기능

  - 프로세스는 임계 구역 앞에서 멈춤 신호를 바등면 잠시 기다리고, 가도 좋다는 신호를 받으면 그제서야 임계 구역에 들어간다.

- 하나의 변수와 두 개의 함수로 구현

  - 전역 변수S: 임계 구역에 진입할 수 있는 프로세스의 개수를 나타냄
  - wait 함수: 임계 구역에 들어가도 좋은지, 기다려야 할지를 알려줌
  - signal 함수: 임계 구역 앞에서 기다리는 프로세스에 '이제 가도 좋다'고 신호를 줌

- 바쁜 대기를 반복하며 CPU 주기를 낭비한다.
  - 실제로 세마포에서 사용하는 방식
  - 1.wait함수는 만일 사용할 수 있는 자원이 없을 경우 해당 프로세스 상태를 대기 상태로 만들고,
    그 프로세스의 PCB를 세마포를 위한 대기 큐에 집어 넣는다.
  - 2.공유 자원이 다시 생기면 대기큐에 프로세스를 지우고 프로세스 상태를 준비상태로 변경한뒤 준비큐로 옮긴다.

## 모니터

- 공유자원과 공유 자원에 접근하기 위한 인터페이스(통로)를 묶어 관리한다.
- 공유 자원을 다루는 인터페이스에 접근하기 위한 큐를 만들고, 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화를 제공한다.
- 실행 순서 제어를 위한 동기화도 제공

  - 특정 조건을 바탕으로 프로세스를 실행하고 일시 중단하기 위해 모니터는 **조건변수**를 사용

    - 조건변수: 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 함수

      - wait: 호출한 프로세스의 상태를 대기 상태로 전환하고 일시적으로 조건변수에 대한 대기 큐를 삽입하는 연산
        - 주의(구분해야될 것)
          - 모니터에 진입하기 위해 삽입되는 큐(상호 배제를 위한 큐) - 한 번에 하나의 프로세스만 진입하도록 하기 위해 만들어진 큐
          - wait가 호출되어 실행이 중단된 프로세스들이 삽입되는 큐(조건 변수에 대한 큐) - 모니터에 이미 진입한 프로세스의 실행 조건이 만족될 때까지 잠시 실행이 중단되어 기다리기 위해 만들어진 큐
      - signal: wait를 호출하여 큐에 삽입된 프로세스의 실행을 재개하는 연산

    - 조건 변수를 이용한 프로세스 실행 순서 제어를 위한 동기화
      - 특정 프로세스가 아직 실행될 조건이 되지 않았을 때에는 wait를 통해 실행을 중단한다
      - 특정 프로세스가 실행될 조건이 충족되었을 때에는 signal을 통해 실행을 재개한다.
