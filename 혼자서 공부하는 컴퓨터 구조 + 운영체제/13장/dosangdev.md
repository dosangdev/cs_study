# 13 교착상태

## 13-1 교착상태란

- 교착상태: 일어나지 않을 사건을 기다리며 진행이 멈춰버리는 현상
  - 해결
    - 교착상태가 발생했을 때의 상황을 정확히 표현한다(자원할당 그래프).
    - 교착상태가 일어나는 근본적인 이유를 알아야한다.

### 자원 할당 그래프

- 목적

  - 교착상태를 단순하게 표현
  - 어떤 프로세스가 어떤 자원을 사용하는지 표현
  - 어떤 프로세스가 어떤 자원을 기다리고 있는지 표현

- 규칙
  - 프로세스는 원으로, 자원의 종류는 사각형으로 표현
  - 사용할 수 있는 자원의 개수는 자원 사각형 내에 점으로 표현
  - 프로세스가 어떤 자원을 할당받아 사용 중이라면 **자원에서 프로세스를 향해** 화살표를 표시
  - 프로세스가 어떤 자원을 기다리고 있다면 **프로세스에서 자원으로** 화살표를 표시

![자원할당그래프] (https://4.bp.blogspot.com/-OTnvPtt-ydA/WPyrrxMLMJI/AAAAAAAABI4/QQj_tRWqc6oetbcykf1WgERy-o4GNf0_wCLcB/s1600/ResourceAllocation.png)

![식사하는철학자-자원할당그래프] (https://1.bp.blogspot.com/-DtIlVw7iq0w/WPyxfte_bHI/AAAAAAAABJc/s1SofcDzTIAjFnesGhqbAx7O_pYJ8uyZgCLcB/s1600/deadlock04.png)

### 교착 상태 발생 조건

- 조건(하나라도 만족하지 않는다면 교착상태 발생x)

  - 상호 배제: 한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없을 때
  - 점유와 대기: 자원을 할당받은 상태에서 다른 자원을 할당받기를 기다리는 상태
  - 비선점: 어떤 자원을 이용하는 프로세스의 작업이 끝나야만 이용할 수 있는 비선점 방식
  - 원형 대기: 프로세스들이 원의 형태로 자원을 대기하는 것(발생할 **수** 있다)

<hr/>

## 13-2 교착 상태 해결 방법

### 교착 상태 예방

- 방법: 교착상태 발생조건 4가지 중 하나를 충족하지 못하게 하는 방법

  - 상호 배제: 모든 자원을 공유 가능하게 만든다

    - 현실적으로 무리(프린트같은 입출력 장치를 공유하는 건 안된다)

  - 점유와 대기: 특정 프로세스에 자원을 모두 할당 or 아예 할당하지 않는 방식

    - 단점: 자원의 활용률이 낮아질 우려가 있다(기아현상 발생 우려도 있다).

  - 비선점: 자원을 이용 중인 프로세스로부터 해당 자원을 빼앗는 방법

    - CPU 시간과 같은 자원에 효과적
    - 프린터같은 자원에겐X
    - -> 비선점 조건을 없애는건 범용성이 떨어진다.

  - 원형 대기: 모든 자원에 번호를 붙이고, 오름차순으로 자원을 할당
    - 모든 컴퓨터 시스템 내에 존재하는 수많은 자원에 번호를 붙이는건 간단한 작업X
    - 각 자원에 어떤 번호를 붙이는지에 따라 특정 자원에 활용률이 떨어질 수 있다.

- 발생 조건을 원천적으로 제거하여 교착상태를 사전에 방지하는 예방방식은 발생 방지를 보장하지만 여러 부작용이 따른다.

### 교착 상태 회피

- 교착상태를 **한정된 자원**의 무분별한 할당으로 인해 발생하는 문제로 간주

  - 프로세스들에 배분할 수 있는 자원의 양을 고려하여 교착상태가 발생하지 않을 정도의 양만큼만 자원을 배분하는 방법(교착 상태 회피)을 사용하여 해결

- 예시 시나리오:

  > 자원의 종류: 1종류 (예: A)
  > 자원의 총량: 10개
  > 시스템에는 3개의 프로세스(P1, P2, P3)가 실행 중
  > 각 프로세스의 최대 자원 요구량과 현재 할당량은 다음과 같습니다:

  > | 프로세스 | 최대 요구량 | 현재 할당량 |
  > | -------- | ----------- | ----------- |
  > | P1       | 6개         | 2개         |
  > | P2       | 4개         | 2개         |
  > | P3       | 5개         | 3개         |

  > 실행 과정:
  > 시스템은 각 프로세스의 최대 요구량을 파악하고 현재 사용 가능한 자원의 양을 계산합니다.
  > 어떤 프로세스가 자원 요청을 할 때, 시스템은 그 요청이 처리된 후에도 안전한 상태를 유지할 수 있는지 확인합니다.
  > 예를 들어, P1이 추가로 3개의 A 자원을 요청한다면, 시스템은 P1에게 추가 자원을 할당한 후에도 남은 자원으로 다른 프로세스들이 최대 요구량을 충족할 수 있는지 확인합니다.
  > P1에게 추가 자원을 할당해도 남은 자원(3개)은 P2 또는 P3의 최대 요구량을 충족할 수 있으므로, 요청을 승인할 수 있습니다.
  > 하지만, P1이 5개의 추가 자원을 요청한다면, 이는 남은 자원(3개)으로는 P2 또는 P3가 막혔을 때 그들의 요구를 충족시킬 수 없으므로, 이 요청은 거절됩니다.
  > 이 방식은 시스템이 교착 상태에 빠지는 것을 효과적으로 회피할 수 있게 해줍니다. 그러나, 자원 할당의 최대 요구량을 미리 알아야 하며, 높은 > 오버헤드와 복잡성을 가져올 수 있다는 단점이 있습니다.

- 안전 상태: 교착상태가 발생하지 않고 모든 프로세스가 정상적으로 자원을 할당받고 종료될 수 있는 상태(안전 순서열을 가진 상황)
- 불안전 상태: 교착 상태가 발생할 수도 있는 상황(안전 순서열이 없는 상황)
- 안전 순서열: 교착상태없이 안전하게 프로세스들에 자원을 할당할 수 있는 순서

### 교착 상태 검출 후 회복

    교착상태 발생을 인정하고 사후에 조치하는 방식

- 운영체제는 프로세스들이 자원을 요구할 때마다 그때그때 모두 할당하며, 교착상태 발생 여부를 주기적으로 검사합니다. 그리고 교착상태가 검출되면 그때 비로소 다음과 같은 방식으로 회복한다.

  - 선점을 통한 회복: 교착상태가 **해결될 때까지** 다른 프로세스로부터 자원을 강제로 빼앗고 한 프로세스에 할당하는 방식

  - 프로세스 강제종료를 통한 회복: 교착상태에 놓인 프로세스를 모두 or 한 프로세스씩 강제종료하는 방식
    - 모두 강제종료 시: 작업내역을 잃게 될 가능성이 있다.
    - 한 프로세스씩 강제종료 시: 작업내역을 잃는 프로세스는 최대한 줄일 수 있지만 교착상태가 없어졌는지 여부를 확인하는 과정에서 오버헤드를 야기한다.
    - 가장 단순하면서 확실한 방식
  - 타조 알고리즘: 드물게 발생하는 잠재적 문제를 무시하는 방식
    - 교착 상태의 발생 빈도가 매우 낮은 경우
    - 교착 상태의 영향이 미미한 경우
    - 복구 비용이 낮은 시스템
