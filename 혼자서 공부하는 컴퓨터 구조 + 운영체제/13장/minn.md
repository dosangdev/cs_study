# 13장. 교착 상태 (Deadlock)

## 13-1. 교착 상태란,

#### 식사하는 철학자 문제 (The Dining-Philosophers Problem)
철학자 다섯 명이 원형 식탁에 둘러 앉아있다. 가운데는 음식이 놓여 있고, 철학자들 사이에는 포크가 있다.

![image](https://github.com/Minnie5382/devduck-cs-study/assets/97179789/8679c15e-404d-4099-9ac3-fdf0086581a3)

<details>
<summary>식사하는 철학자 문제</summary>
<div>

철학자 다섯 명이 원형 식탁에 둘러 앉아있다. 철학자 앞에는 음식이 놓여 있고, 철학자들 사이에는 포크가 있다.

철학자는 양쪽 포크를 모두 집어야 식사를 할 수 있다.

철학자들은 아래 순서로 식사를 한다.

1. 일정 시간 생각을 한다.
2. 왼쪽 포크가 사용 가능해질 때까지 대기한다. 만약 사용 가능하다면 집어든다.
3. 오른쪽 포크가 사용 가능해질 때까지 대기한다. 만약 사용 가능하다면 집어든다.
4. 양쪽의 포크를 잡으면 일정 시간만큼 식사를 한다.
5. 오른쪽 포크를 내려놓는다.
6. 왼쪽 포크를 내려놓는다.
7. 다시 1번으로 돌아간다.

</div>
</details>

이 문제에서, 철학자들은 아무도 식사를 하지 못하고, 전원이 영원한 대기 상태에 빠져 버린다. 이를 **교착 상태**라고 한다.

> 교착 상태 : 두 개 이상의 작업이 서로 상대방의 작업이 끝나기 만을 기다리고 있기 때문에 결과적으로 아무것도 완료되지 못하는 상태.

#### 교착 상태의 상황 파악 - 자원 할당 그래프
> 자원 할당 그래프 : 어떤 프로세스가 어떤 자원을 사용하고 있고, 어떤 자원을 기다리는 중인지를 표현한 그래프

- 프로세스는 원, 자원은 사각형, 사각형 안에 자원의 개수만큼 점
- 프로세스가 사용하고 있는 자원은 **자원 → 프로세스**
- 프로세스가 대기중인 자원은 **프로세스 → 자원**
     
![image](https://github.com/Minnie5382/devduck-cs-study/assets/97179789/e5a027ed-076b-4bdf-bcad-3c317ca43f9c)

- 식사하는 철학자 문제의 자원 할당 그래프
  
  ![image](https://github.com/Minnie5382/devduck-cs-study/assets/97179789/ad3fd884-f628-4895-bdf1-5e2ca4a164e6)

> 교착 상태가 발생한 상황은 자원 할당 그래프가 원의 형태를 띈다.

#### 교착 상태 발생 조건
- 교착 상태가 발생하는 조건은 4가지이며, 이 중 하나라도 충족하지 않으면 교착 상태는 발생하지 않는다.
1. 상호 배제 : 한 자원은 한번에 한 프로세스만 이용 가능하다.
2. 점유와 대기 : 프로세스가 자원을 보유한 채 다른 자원을 기다린다.
3. 비선점 : 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못한다.
4. 원형 대기 : 자원 할당 그래프가 원의 형태로 그려진다.

## 13-2. 교착 상태의 해결 방법
#### 1. 교착 상태 예방
> 교착 상태 발생 조건 4가지 중, 한 가지라도 충족하지 못하게 하면 교착 상태가 발생할 수 없으므로 예방할 수 있다.
1. 상호 배제를 없앤다.<br>
   - 모든 자원을 동시에 여러 프로세스가 공유할 수 있게 한다. - ???
2. 점유와 대기를 없앤다.<br>
   - 포크를 들 때는 양쪽 두 개를 동시에 들던가, 아니면 아예 안들던가!
   - 자원의 활용률↓
3. 비선점 조건을 없앤다.<br>
   - 옆 철학자가 들고 있는 포크를 뺏을 수 있다.
   - 범용성↓
4. 원형 대기 조건을 없앤다.
   - 철학자들을 일렬로 앉힌다. - 모든 자원에 번호를 붙이고 오름차순 할당
   - 비용↑, 번호에 따라 자원 활용률↓
     

#### 2. 교착 상태 회피
> 교착 상태가 발생하지 않을 정도로 적은 양의 자원만 배분하는 방법.
> (포크 100개 준비해놓고, 한 개 씩만 배분하기)

- 안전 상태 : 교착 상태가 발생하지 않는 상태 (안전 순서열 O)
- 안전 순서열 : 안전 상태에서 교착 상태 없이 안전하게 자원을 할당할 수 있는 순서
- 불안전 상태 : 교착 상태가 필연적으로 발생하는 상태 (안전 순서열X)


<img width="500" alt="image" src="https://github.com/Minnie5382/devduck-cs-study/assets/97179789/c2f83b66-5352-4c19-b693-689c3336316e">


- 위의 경우 안전 순서열 : P2 → P1 → P3
- 안전 순서열이 존재하기 때문에, 안전 상태
  
#### 3. 교착 상태 검출 후 회복
> 교착 상태가 발생했는지 주기적으로 검사, 검출되면 다음과 같은 방식으로 회복하는 방법

1. 선점을 통한 회복
2. 프로세스 강제 종료를 통한 회복
     - 교착 상태에 놓인 프로세스 모두 강제 종료 : 많은 프로세스의 작업 내역 소실
     - 한 프로세스씩 강제 종료 : 오버 헤드↑
3. 타조 알고리즘
     - 드문 문제에 대해선 걍 마이웨이하는 개발자스러운 해결법
