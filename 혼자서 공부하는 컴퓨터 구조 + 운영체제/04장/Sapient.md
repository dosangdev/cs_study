# CPU의 작동 원리


## 04-1 ALU와 제어장치

### ALU: 계산을 담당하는 장치

- ALU가 받아들이는 정보
    - 피연산자
    - 제어 신호: 제어장치로부터 수행할 연산
- ALU가 내보내는 정보
    - 연산을 수행한 결괏값 —> 레지스터
    - 플래그: 연산 결과에 대한 추가적인 상태 정보 —> 플래그 레지스터

### 제어장치

- 제어장치는 제어 신호를 내보내고, 명령어를 해석하는 부품이다.
- 제어 신호는 컴퓨터 부품들을 관리하고 작동시키기 위한 일종의 전기 신호
- 제어장치가 받아들이는 정보
    - 클럭 신호: 클럭이란 컴퓨터의 모든 부품을 일사불란하게 움직일 수 있게 하는 시간 단위
    - 해석해야 할 명령어
    - 플래그 레지스터 속 플래그 값
    - 제어 버스로 전달된 제어 신호
- 제어장치가 내보내는 정보
    - CPU 외부: 제어 버스로 메모리 제어 신호나 입출력장치 제어 신호를 내보낸다
    - CPU 내부: ALU에 전달하는 제어 신호, 레지스터에 전달하는 제어 신호

## 04-2 레지스터

### 반드시 알아야 할 레지스터

- 프로그램 카운터: 메모리에서 가져올 명령어의 주소. 메모리에서 읽어 들일 명령어의 주소를 저장한다.
- 명령어 레지스터: 해석할 명령어, 즉 방금 메모리에서 읽어 들인 명령어를 저장하는 레지스터.
- 메모리 주소 레지스터: 메모리의 주소를 저장하는 레지스터
- 메모리 버퍼 레지스터: 메모리와 주고받을 값(데이터와 명령어)을 저장하는 레지스터.
- 범용 레지스터: 다양하고 일반적인 상황에서 자유롭게 사용할 수 있는 레지스터.
- 플래그 레지스터: 연산 결과 또는 CPU 상태에 대한 부가적인 정보를 저장하는 레지스터

### 특정 레지스터를 이용한 주소 지정 방식(1): 스택 주소 지정 방식

- 스택과 스택 포인터를 이용한 주소 지정 방식
- 스택은 가장 최근에 저장하는 값부터 꺼낼 수 있고, 스택 포인터는 스택의 꼭대기를 가리키는 레지스터이다. 즉, 스택에 마지막으로 저장한 값의 위치를 저장하는 레지스터 이다.
- 스택은 메모리 안에 있다. 정확히는 메모리 안에 스택처럼 사용할 영역이 정해져 있는데 이를 스택 영역 이라고 한다.

### 특정 레지스터를 이용한 주소 지정 방식(2): 변위 주소 지정 방식

- 오퍼랜드 필드의 값(변위)과 특정 레지스터의 값을 더하여 유효 주소를 얻어내는 주소 지정 방식
- 변위 주소 지정 방식은 오퍼랜드 필드의 주소와 어떤 레지스터를 더하는지에 따라 상대 주소 지정 방식, 베이스 레지스터 주소 지정 방식 등으로 나뉜다.
    - 상대 주소 지정 방식: 오퍼랜드와 프로그램 카운터의 값을 더하여 유효 주소를 얻는 방식
    - 베이스 레지스터 주소 지정 방식: 오퍼랜드와 베이스 레지스터의 값을 더하여 유효 주소를 얻는 방식이다. 베이스 레지스터가 기준 주소가 되고 오퍼랜드는 기준 주소로부터 떨어진 거리이다. 즉, 베이스 레지스터 속 기준 주소로부터 얼마나 떨어져 있는 주소에 접근할 것인지를 연산하여 유효 주소를 얻어내는 방식이다.

## 04-3 명령어 사이클과 인터럽트

- 하나의 명령어를 처리하는 정형화된 흐름을 명령어 사이클이라고 한다.
- 정해진 흐름에 따라 명령어를 처리해 나가지만, 간혹 이 흐름이 끊어지는 상황이 발행하는데 이를 인터럽트라고 한다.

### 명령어 사이클

- 프로그램 속 각각의 명령어들은 일정한 주기가 반복되며 실행되는데, 이 주기를 명령어 사이클이라고 한다.
- 명령어를 메모리에서 CPU로 가져오는 사이클의 첫 번째 과정을 인출 사이클 이라고 한다.
- 두 번째로 가져온 명령어를 실행하는 단계를 실행 사이클이라고 한다.
- 프로그램을 이루는 수많은 명령어는 인출과 실행 사이클을 반복하면서 실행된다.
- 명령어를 인출한다 해도 메모리 접근이 한 번 더 필요한 경우 간접 사이클을 거치고 실행 사이클이 실행된다.

### 인터럽트

- CPU가 수행 중인 작업은 방해를 받아 잠시 중단될 수 있는데, 이렇게 CPU의 작업을 방해하는 신호를 인터럽트라고 한다.
- 인터럽트의 종류에는 동기 인터럽트와 비동기 인터럽트가 있다.
    - 동기 인터럽트: CPU에 의해 발생하는 인터럽트. CPU가 실행하는 프로그래밍상의 오류와 같은 예외적인 상황에 마주쳤을 때 발생하는 인터럽트가 동기 인터럽트이다. 예외라고 부른다.
    - 비동기 인터럽트: 주로 입출력 장치에 의해 발생하는 인터럽트.(프린트 완료 알림, 마우스나 키보드 입력 알림 등) 일반적으로 비동기 인터럽트를 인터럽트라 하기도 하고 하드웨어 인터럽트라고 하기도 한다.
- 하드웨어 인터럽트
    - 알림과 같은 인터럽트이다. CPU가 입출력 작업 도중에도 효율적으로 명령어를 처리하기 위해 알림과 같은 하드웨어 인터럽트를 사용한다.
- 하드웨어 인터럽트 처리 순서
    1. 입출력 장치가 CPU에 끼어들어도 되냐는 신호인 인터럽트 요청 신호를 보낸다.
    2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 체크한다.
    3. CPU가 인터럽트 요청을 확인하고 플래그 레지스터의 인터럽트 플래그를 통해 인터럽트를 받아 들일 수 있는지 여부를 확인한다.
    4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업한다.
    5. CPU는 인터럽트 서비스 루틴의 식별 정보인 인터럽트 벡터를 참조하여 인터럽트 서비스 루틴을 실행한다.
    6. 인터럽트 서비스 루틴이 끝나면 4번으로 돌아가 백업해 둔 작업을 복구하여 실행을 재개한다.
- 하드웨어 인터럽트에는 인터럽트 플래그로 막을 수 있는 인터럽트가 있고 인터럽트 플래그가 불가능으로 설정되어 있더라도 무시할 수 없는 요청인 막을 수 없는 인터럽트(정전, 하드웨어 고장으로 인한 인터럽트)가 있다.
- 인터럽트 서비스 루틴은 어떤 인터럽트가 발생했을 때 해당 인터럽트를 어떻게 처리하고 작동해야 할지에 대한 정보로 이루어진 프로그램이다. 인터럽트 핸들러라고도 부른다.
- 인터럽트를 처리하는 방법은 입출력장치마다 다르므로 각기 다른 인터럽트 서비스 루틴을 가지고 있다.
