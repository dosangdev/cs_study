# ALU와 제어장치

CPU 내부에서 계산을 담당하는 ALU와 명령어를 읽어 들이고 해석하는 제어장치에 대해 학습하자

## ALU

1. 레지스터를 통해 피연사자를 받아들이고, 제어장치로부터 수행할 연산을 알려주는 제어 신호를 받아들인다.
2. 특정 숫자, 문자 혹은 메모리 주소가 될 수 있는 결과값을 일시적으로 레지스터에 저장한다.
3. ‘플래그’라는 추가정보를 플래그 레지스터에 담는다.

### 플래그 종류

1. 부호 플래그
2. 제로 플래그
3. 캐리 플래그
4. 오버플로우 플래그
5. 인터럽트 플래그
6. 슈퍼바이저 플래그

## 제어장치

CPU의 구성 요소 중 가장 정교하게 설계된 부품.

그래서 CPU 제조사마다 구현 방식이나 명령어를 해석하는 방식 등에 조금씩 차이가 있다.

### 제어장치의 흐름

1. 제어장치는 클럭 신호를 받아들인다.
- 컴퓨터의 모든 부품을 일사불란하게 움직일 수 있게 하는 시간 단위
    - 이 박자에 맞춰 데이터가 이동되거나,  CPU가 메모리에 저장된 명령어를 읽어 들인다.
    - 하나의 명령어가 여러 클럭에 걸쳐 실행될 수 있다.

1. 제어장치는 ‘해석해야 할 명령어’를 받아들인다.
- 명령어 레지스터로부터 해석할 명령어를 받아들인다.

1. 제어장치는 플래그 레지스터 속 플래그 값을 바아들인다.

1. 제어장치는 시스템 버스, 그 중에서 제어 버스로 전달된 제어 신호를 받아들인다.

### 외부에 전달하는 제어 신호와 CPU 내부에 전달하는 제어 신호

1. 외부에 전달하는 제어 신호는 크게 메모리에 전달하는 제어 신호와 입출력장치에 전달하는 제어 신호가 있다.
2. 내부에 전달하는 제어신호에는 크게 ALU에 전달하는 제어 신호와 레지스터에 전달하는 제어 신호가 있다.

# 레지스터

명령어와 데이터는 실행 전후로 반드시 레지스터에 저장된다.

## 반드시 알아야 할 레지스터

1. 프로그램 카운터
2. 명령어 레지스터
3. 메모리 주소 레지스터
4. 메모리 버퍼 레지스터
5. 플래그 레지스터
6. 범용 레지스터
7. 스택 포인터
8. 베이스 레지스터

### 프로그램 카운터

메모리에서 가져올 명령어의 주소, 즉 메모리에서 읽어 들일 명령어의 주소를 저장한다.

명령오 포인터라고 부르는 CPU도 있다.

### 명령어 레지스터

방금 메모리에서 읽어 들인 명령어를 저장하는 레지스터

### 메모리 주소 레지스터

메모리의 주소를 저장하는 레지스터

CPU가 읽어 들이고자 하는 주소 값을 주소 버스로 보낼 때 메모리 주소 레지스터를 거치게 된다.

### 메모리 버퍼 레지스터

메모리와 주고받을 값(데이터와 명령어)을 저장하는 레지스터

### 범용 레지스터

일반적인 상황에서 자유롭게 사용할 수 있는 레지스터. 현대 대다수 CPU는 모두 범용 레지스터를 가지고 있다.

### 플래그 레지스터

연산 결과 또는 CPU 상태에 대한 부가적인 정보를 저장하는 레지스터

## 특정 레지스터를 이용한 주소 지정 방식(1) : 스택 주소 지정 방식

- 스택과 스택 포인터를 이용한 주소 지정 방식
    - 스택 포인터는 스택의 제일 꼭대기 주소, 즉 스택의 어디까지 데이터가 채워쳤는지 표시해 주는 포인터이다.
    - 스택은 메모리 안에 스택처럼 사용할 영역이 정해져 있다. 이것을 스택 영역이라고 한다.

## 변위 주소 지정 방식

- 오퍼랜드 필드의 값과 특정 레지스터의 값을 더하여 유효 주소를 얻어내는 주소 지정 방식
- 변위 주소 지정 방식을 사용하는 명령어는 연산 코드 필드 + 레지스터 필드 + 오퍼랜드 필드
- 상대 주소 지정 방식과 베이스 레지스터 주소 지정 방식 등으로 나뉜다.

### 상대 주소 지정 방식

오퍼랜드와 프로그램 카운터의 값을 더하여 유효 주소를 얻는 방식

### 베이스 레지스터 주소 지정 방식

오퍼랜드와 베이스 레지스터의 값을 더하여 유효 주소를 얻는 방식

# 명령어 사이클과 인터럽트

CPU가 하나의 명령어를 처리하는 과정에는 어떤 정해진 흐름이 있고, CPU는 그 흐름을 반복하며 명령어들을 처리해 나간다. 이렇게 하나의 명령어를 처리하는 정형화된 흐름을 명령어 사이클이라고 한다.

그러다가 이 흐름이 끊어지는 상황이 발생하는데, 이를 인터럽트라고 한다.

## 명령어 사이클

1. 메모리에 있는 명령어를 CPU로 가지고 오는 단계를 인출 사이클이라 한다.
2. CPU로 가져온 명령어를 실행하는 단계를 실행 사이클이라고 한다.

이 인출과 실행 사이클을 수 없이 반복하며 프로그램은 동작한다.

1. 이렇게 간단히 실행되지 않는 경우도 있는데, 예를 들어 간접 주소 방식에서는 오퍼랜드 필드에 유효 주소의 주소를 명시한다고 했다. 그렇기 때문에, 바로 실행 사이클에 돌입할 수 없고 메모리 접근을 한 번 더 해줘야 한다.
2. 추가로 인터럽트도 고려해야 한다.

## 인터럽트

CPU의 작업을 방해하는 신호

인터럽트는 크게 동기 인터럽트와 비동기 인터럽트로 나뉜다.

### 동기 인터럽트

- CPU에 의해 발생하는 인터럽트
    - CPU가 명령어들을 수행하다가 예상치 못한 상황에 마주쳤을 때와 같은 예외적인 상황에 발생하는 인터럽트. 예외(exception)이라고 불린다.

### 비동기 인터럽트

- 주로 입출력장치에 의해 발생하는 인터럽트
    - 세탁기 완료 알림, 전자레인지 조리 완료 알림과 같은 알림 역할을 한다.
- 그냥 인터럽트라고 불리기도 하지만, 이 책에서는 하드웨어 인터럽트라는 용어를 사용한다.

### 하드웨어 인터럽트

- cpu는 입출력 작업 도중에도 효율적으로 명령어를 처리하기 위해 이런 알림과 같은 하드웨어 인터럽트를 사용한다.
    - 하드웨어 인터럽트를 사용하면 cpu보다 속도가 현저히 느린 프린터가 작업을 끝날 때 까지 주기적으로 확인해 줄 필요가 없다. 그래서 다른 작업을 하는 것이 가능해진다.
- 처리순서
1. 입출력장치는 CPU에 인터럽트 요청 신호를 보낸다.
2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 확인한다.
3. CPU는 인터럽트 요청을 확인하고 인터럽트 플래그를 통해 현재 인터럽트를 받아들일 수 있는지 여부를 확인한다.
4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업한다.
5. CPU는 인터럽트 벡터를 참조하여 인터럽트 서비스 루틴을 실행한다.
6. 4에서 백업해 둔 작업을 복구하여 실행을 재개한다.

- 인터럽트 요청 신호 : 인터럽트를 해도 되는지 CPU에 물어보는 신호
- 인터럽트 플래그 : 하드웨어 인터럽트를 받아들일지 무시할지 결정하는 플래그, 다만 모든 하드웨어 인터럽트를 이 플래그로 막지는 못한다. 예시로는 정전이나, 하드웨어 고장등이 있다.
- 인터럽트 서비스 루틴 (인터럽트 핸들러) : 인터럽트가 발생했을 때 해당 인터럽트를 어떻게 처리하고 작동해야 할지에 대한 정보로 이루어진 프로그램
    - 입출력장치마다 각기 다른 인터럽트 서비스 루틴을 가지고 있다.
- 인터럽트 벡터 : CPU가 수많은 인터럽트 서비스 루틴을 구분하기 위해 사용하는 정보 (인터럽트 서비스 루틴의 시작 주소를 알 수 있다.)