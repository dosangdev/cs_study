# 14. 가상 메모리



## 14-1. 연속 메모리 할당
### 프로세스에 연속적인 메모리 공간을 할당하는 방식


### 스와핑
#### 프로세스들을 임시로 보조기억장치 일부 영역으로 쫓아내고, 그렇게 해서 생긴 메모리상의 빈 공간에 또 다른 프로세스를 적재하여 실행하는 방식
> 스왑 영역: 프로세스들이 쫓겨나는 보조기억장치의 일부 영역
> 스왑 아웃: 메모리에서 스왑 영역으로 옮겨지는 것
> 스왑 인: 스왑 영역에 있던 프로세스를 다시 메모리로 옮겨오는 것
#### 스와핑을 이용하면 프로세스들이 요구하는 메모리 주소 공간의 크기가 실제 메모리 크기보다 큰 경우에도 프로세스들을 동시 실행할 수 있다.


### 메모리 할당
#### 비어 있는 메모리 공간에 프로세스를 연속적으로 할당하는 방식
> - 최초 적합: 메모리 내의 빈 공간을 순서대로 검색하다가 적재할 수 있는 공간을 발견하면 그 공간에 프로세스를 배치하는 방식. 검색을 최소화할 수 있고 빠른 할당이 가능하다.
> - 최적 적합: 빈 공간을 모두 검색해 본 후, 프로세스가 적재될 수 있는 공간 중 가장 작은 공간에 프로세스를 배치하는 방식
> - 최악 적합: 운영체제가 빈 공간을 모두 검색해 본 후, 프로세스가 적재될 수 있는 공간 중 가장 큰 공간에 프로세스를 배치하는 방식


### 외부 단편화
#### 프로세스 바깥에 빈 공간이 생겼지만 그 공간보다 큰 프로세스를 적재하기는 어려워 메모리가 낭비되는 현상
#### 메모리 내에 저장된 프로세스들을 적당히 재배치시켜 작은 빈 공간들을 하나로 모아 큰 공간으로 만드는 압축 방식으로 해결할 수 있다.
#### 압축 방식의 단점
> - 시스템이 하던 일을 중지해야 함
> - 메모리에 있는 내용을 옮기는 작업에서 오버헤드가 발생함
> - 오버헤드를 최소화 하며 압축할 수 있는지에 대한 명확한 방법을 결정하기 어려움
#### 또 다른 해결 방안으로는 가상 메모리 기법인 페이징 기법이 있다.



## 14-2. 페이징을 통한 가상 메모리 관리
#### 가상 메모리는 실행하고자 하는 프로그램을 일부만 메모리에 적재하여 실제 물리 메모리 크기보다 더 큰 프로세스를 실행할 수 있게 하는 기술이다.


### 페이징이란
#### 프로세스의 논리 주소 공간을 페이지라는 일정한 단위로 자르고, 메모리 물리 주소 공간을 프레임이라는 페이지와 동일한 크기의 일정한 단위로 자른 뒤 페이지를 프레임에 할당하는 가상 메모리 관리 기법
#### 페이징에서도 스와핑을 사용할 수 있으며, 페이지 단위로 스왑 아웃/스왑 인된다.
#### 페이징에서 스와핑이 가능하다는 말은 한 프로세스를 실행하기 위해 프로세스 전체가 메모리에 적재될 필요가 없다는 말을 의미한다.


### 페이지 테이블
#### 프로세스가 메모리에 불연속적으로 배치되면 CPU 입장에서는 다음에 실행할 명령어 위치를 찾기가 어려워지기 때문에 프로세스가 비록 실제 메모리 내의 주소인 물리 주소에 불연속적으로 배치되더라도 CPU가 바라보는 주소인 논리 주소에는 연속적으로 배치되도록 페이지 테이블을 이용한다.
#### 즉, 페이지 테이블은 CPU가 페이지 번호만 보고 해당 페이지가 적재된 프레임을 찾을 수 있게하는 이정표이다.
#### 각 프로세스의 페이지 테이블들은 메모리에 적재되어 있고 CPU 내의 페이지 테이블 베이스 레지스터(PTBR)는 각 프로세스의 페이지 테이블이 적재된 주소를 가리키고 있다.
#### 페이지 테이블이 메모리에 있으면 페이지 테이블을 보려고 한번, 알게 된 프레임에 접근하려고 한번 총 두 번의 메모리 접근이 필요해서 시간이 두배로 걸린다
#### 이를 해결하기위에 CPU 곁에 TLB라는 페이지 테이블의 캐시 메모리를 둔다. TLB에는 페이지 테이블의 일부 내용을 저장한다.
#### CPU가 발생한 논리 주소에 대한 페이지 번호가 TLB내에 있을 경우 TLB 히트, 아닐 경우 TLB 미스라고 한다.



### 페이징에서의 주소 변환
#### 하나의 페이지 혹은 프레임은 여러 주소를 포괄하고 있고 특정 주소에 접근하려면 두 가지 정보가 필요하다
> 어떤 페이지 혹은 프레임에 접근하고 싶은지
> 접근하려는 주소가 그 페이지 혹은 프레임으로부터 얼마나 떨어져 있는지
#### 페이징 시스템에서는 모든 논리 주소가 기본적으로 페이지 번호와 변위로 이루어져 있다.
> 페이지 번호: 접근하고자 하는 페이지 번호
> 변위: 접근하려는 주소가 프레임의 시작 번지로부터 얼만큼 떨어져 있는지를 알기 위한 정보


### 페이지 테이블 엔트리
#### 페이지 테이블의 각각의 행들
#### 페이지 테이블 엔트리에 담기는 대표적인 정보
> 유효 비트: 현재 해당 페이지에 접근 가능한지 여부를 알려준다. 페이지가 메모리에 적재되어 있으면 1, 아니면 0 이다. 유효 비트가 0인 페이지로 접근하려고 하면 페이지 폴트라는 예외가 발생한다.
> 보호 비트: 페이지 보호 기능을 위해 존재한다. 읽기만 가능한지, 쓰기도 가능한지, 실행도 가능한지를 나타낼 수 있다.
> 참조 비트: CPU가 이 페이지에 접근한 적이 있는지 여부를 나타낸다.
> 수정 비트: 해당 페이지에 데이터를 쓴 적이 있는지 없는지 수정 여부를 알려준다.(더티 비트라고도 한다.)
> > 수정 비트가 필요한 이유: 수정된 적이 있는 페이지가 스왑 아웃 될 경우 변경된 값을 보조기억장치에 기록하는 작업이 추가되어야 하므로 페이지가 메모리에서 사라질 때 보조기억장치에 쓰기 작업을 해야 하는지, 할 필요가 없는지를 판단하기 위해서 필요하다.



<hr/>


## 14-3. 페이지 교체와 프레임 할당
### 요구 페이징
#### 프로세스를 메모릴에 적재할 때 처음부터 모든 페이지를 적재하지 않고 필요한 페이지만을 메모리에 적재하는 기법
#### 요구 페이징의 기본 양상
> 1. CPU가 특정 페이지에 접근하는 명령어를 실행.
> 2. 해당 페이지가 현재 메모리에 있을 경우 CPU는 페이지가 적재된 프레임에 접근
> 3. 해당 페이지가 현재 메모리에 없을 경우 페이지 폴트가 발생
> 4. 페이지 폴트 처리 루틴으로 해당 페이지를 메모리로 적재하고 유효 비트를 1로 설정
> 5. 다시 1번을 수행
##### 메모리에 아무런 페이지도 적재하지 않고 실행해 처음에는 페이지 폴트가 계속 발생하지만 이후 페이지가 어느정도 적재되면 페이지 폴트 발생 빈도가 떨어지는 순수 요구 페이징 기법도 있다.
#### 페이징 시스템이 안정적으로 작동하기 위해서는 페이지 교체와 프레임 할당을 해결해야 한다.



### 페이지 교체 알고리즘
#### 쫓아낼 페이지를 결정하는 방법으로서 페이지 폴트를 가장 적게 일으키는 알고리즘을 좋은 알고리즘으로 평가한다.
#### 페이지 참조열을 통해 알 수 있는 페이지 폴트 횟수를 통해 페이지 교체 알고리즘을 이해할 수 있다.

 - FIFO 페이지 교체 알고리즘: 메모리에 가장 먼저 올라온 페이지부터 내쫓는 방식. 아이디어와 구현이 간단하지만 메모리에 먼저 적재되었지만 프로그램 실행 내내 사용되어야 할 프로세스가 내쫓아진다는 단점이 있다.
 - 최적 페이지 교체 알고리즘: 앞으로의 사용 빈도가 가장 낮은 페이지를 교체하는 알고리즘이다. 가장 낮은 페이지 폴트율을 보장하지만 실제 구현이 어려워 주로 다른 페이지 교체 알고리즘의 이론상 성능을 평가하기 위해 쓰인다.
 - LRU 페이지 교체 알고리즘: 가장 오랫동안 사용되지 않은 페이지를 교체하는 알고리즘



### 스래싱과 프레임 할당
#### 페이지 폴트가 자주 발생하는 원인에는 나쁜 페이지 교체 알고리즘 뿐만 아니라 프레임 수 부족도 있다.
 - 프레임 수가 부족하면 프로세스가 실제 실행되는 시간보다 페이징에 더 많은 시간을 소요하여 성능이 저해되는 문제가 생기는데 이를 스래싱이라고 한다.
 - 메모리에서 동시에 실행되는 프로세스의 수를 멀티프로그래밍의 정도라고 하는데 멀티 프로그래밍의 정도가 필요 이상으로 많아지면 각 프로세스들이 사용할 프레임 수가 적어져 페이지 폴트가 빈번히 발생하고, CPU 이용률이 떨어져 성능이 저하된다.
 - 프레임 할당 방식
    - 정적 할당 방식(프로세스의 실행 과정 고려X)
       - 균등 할당: 모든 프로세스에 균등하게 프레임을 제공하는 방식. 프로세스마다 크기가 다르므로 동일한 프레임 개수를 할당하는 것은 비합리적이다.
       - 비례 할당: 프로세스 크기가 크면 프레임을 많이 할당하고 작으면 프레임을 적게 나눠주는 방식. 하나의 프로세스가 얼마나 많은 프레임을 필요로 하는지는 실행해 봐야 하는 경우가 많아 완벽한 방식은 아니다.
    - 동적 할당 방식(프로세스의 실행을 보고 결정)
        - 작업 집합 모델: 실행 중인 프로세스가 일정 시간 동안 참조한 페이지의 집합인 작업 집합을 기억하여 빈번한 페이지의 교체를 방지하는 방식
        - 페이지 폴트 빈도: 페이지 폴트율에 상한선과 하한선을 정하고, 이 범위 안에서만 프레임을 할당하는 방식
